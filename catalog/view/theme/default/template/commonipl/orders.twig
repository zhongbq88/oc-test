{{ header }}
<div id="account-account" class="container">
  <div id="content">
    <div class="page-header">
      <div class="container-fluid"><!--{% if error_warning %}
  <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
    <button type="button" class="close" data-dismiss="alert">&times;</button>
  </div>
  {% endif %}--> 
        {% if success %}
        <div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> {{ success }}
          <button type="button" class="close" data-dismiss="alert">&times;</button>
        </div>
        {% endif %}
        <div class="row">
          <div class="panel panel-default">
            <div class="panel-body" > 
              <!-- <div class="panel-heading" style="float:left">
          <h3 class="panel-title"><i class="fa fa-filter"></i> {{ text_filter }}</h3>
        </div>-->
              <div class="form-group" style="float:left" >
                <label class="control-label" for="input-order-id">{{ entry_order_id }}</label>
                <input type="text" name="filter_order_id" value="{{ filter_order_id }}" placeholder="{{ entry_order_id }}" id="input-order-id" class="form-control" />
              </div>
              <div class="form-group" style="float:left; margin-left:20px;">
                <label class="control-label" for="input-customer">{{ entry_customer }}</label>
                <input type="text" name="filter_customer" value="{{ filter_customer }}" placeholder="{{ entry_customer }}" id="input-customer" class="form-control" />
              </div>
              <div class="form-group" style="float:left; margin-left:20px;">
                <label class="control-label" for="input-order-status">{{ entry_order_status }}</label>
                <select name="filter_order_status_id" id="input-order-status" class="form-control">
                  <option value=""></option>
                  
                  <!--  {% if filter_order_status_id == '0' %}
              
              <option value="0" selected="selected">{{ text_missing }}</option>
              
              {% else %}
              
              <option value="0">{{ text_missing }}</option>-->
              
              {% endif %}
              {% for order_status in order_statuses %}
              {% if order_status.order_status_id == filter_order_status_id %}
              
              
                  
                  <option value="{{ order_status.order_status_id }}" selected="selected">{{ order_status.name }}</option>
                  
                  
              
              {% else %}
              
              
                  
                  <option value="{{ order_status.order_status_id }}">{{ order_status.name }}</option>
                  
                  
              
              {% endif %}
              {% endfor %}
            
            
                
                </select>
              </div>
              <div class="form-group" style=" float:right; margin-top:20px;"> <a href="javascript:syn(this);" data-toggle="tooltip" title="Synchronize orders" class="btn btn-primary"><i id="Synchronize" class="fa fa-refresh"></i></a> </div>
              <div class="form-group" style="display:none;">
                <label class="control-label" for="input-date-added">{{ entry_date_added }}</label>
                <div class="input-group date">
                  <input type="text" name="filter_date_added" value="{{ filter_date_added }}" placeholder="{{ entry_date_added }}" data-date-format="YYYY-MM-DD" id="input-date-added" class="form-control" />
                  <span class="input-group-btn">
                  <button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button>
                  </span> </div>
              </div>
              <div class="form-group" style="display:none;">
                <label class="control-label" for="input-date-modified">{{ entry_date_modified }}</label>
                <div class="input-group date">
                  <input type="text" name="filter_date_modified" value="{{ filter_date_modified }}" placeholder="{{ entry_date_modified }}" data-date-format="YYYY-MM-DD" id="input-date-modified" class="form-control" />
                  <span class="input-group-btn">
                  <button type="button" class="btn btn-default"><i class="fa fa-calendar"></i></button>
                  </span> </div>
              </div>
              <div class="form-group" style="float:left; margin-left:20px; margin-top:25px;">
                <button type="button" id="button-filter" class="btn btn-default"><i class="fa fa-filter"></i> {{ button_filter }}</button>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title"><i class="fa fa-list"></i> {{ text_list }}</h3>
            </div>
            <div class="panel-body">
              <form method="post" action="" enctype="multipart/form-data" id="form-order">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <td style="width: 1px;" class="text-center"><input type="checkbox" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);" /></td>
                        <td class="text-right">{{ column_order_id }}</td>
                        <td class="text-left">{{ column_customer }}</td>
                        <!--<td class="text-left">{% if sort == 'product' %} <a href="{{ column_product }}" class="{{ order|lower }}">{{ column_product }}</a> {% else %} <a href="{{ sort_product }}">{{ column_product }}</a> {% endif %}</td>-->
                        <td class="text-left">{{ column_status }}</td>
                        <td class="text-right">{{ column_total }}</td>
                        <td class="text-left">{{ column_date_added }}</td>
                        <!--<td class="text-left">{{ column_quantity }}</td>-->
                        <td class="text-right" style=" text-align:right">{{ column_action }}</td>
                      </tr>
                    </thead>
                    <tbody>
                    
                    {% if orders %}
                    {% for order in orders %}
                    <tr>
                      <td class="text-center"> {% if order.order_id in selected %}
                        <input type="checkbox" id="checkbox{{order.order_id}}" {% if (order.status!='Pending' and order.status!='On-Hold') or  order.total=='$0'   %} disabled {% else %} name="selected[]"  {% endif%} value="{{ order.order_id }}"  />
                        {% else %}
                        <input type="checkbox" id="checkbox{{order.order_id}}" {% if (order.status!='Pending' and order.status!='On-Hold') or order.total=='$0'%} disabled {% else %} name="selected[]"   {% endif%} value="{{ order.order_id }}" />
                        {% endif %}
                        <input type="hidden" name="shipping_code[]" value="{{ order.shipping_code }}" /></td>
                      <td class="text-right">{{ order.shopify_order_id }}</td>
                      <td class="text-left">{{ order.name }}</td>
                      <!--<td class="text-left">{{ order.products }}</td>-->
                      <td class="text-left" id="status{{order.order_id}}" >{{ order.status }} {% if order.total =='$0' %} <span style="background:#CCC">{{text_not_customdr_order}}</span> {% endif %}</td>
                      <td class="text-right">{{ order.total }}</td>
                      <td class="text-left">{{ order.date_added }}</td>
                      
                      <!--<td class="text-left">{{ order.date_modified }}</td>-->
                      <td class="text-right"><div style="float:right">
                          <div class="btn-group" style="float:left;">
                          <button type="button" {% if (order.status!='Pending' and order.status!='On-Hold') or order.total=='$0' %} disabled {% endif%} onClick="payclick('{{order.pay}}');" id="pay{{order.order_id}}"   class="btn btn-success btn-xs" > {% if order.status=='In-Production' or order.status=='Shipped' %}{{ text_paid }}{% else %}{{ text_checkout }}{% endif %}</button></div>
                          <div class="btn-group"  style="float:left; margin-left:20px;"> <a href="{{ order.view }}" data-toggle="tooltip" title="{{ button_view }}" class="btn btn-primary"><i class="fa fa-eye"></i>{{ button_view }}</a>
                            <button type="button" {% if (order.status!='Pending' and order.status!='On-Hold') or order.total=='$0' %} disabled {% endif%}  data-toggle="dropdown" class="btn btn-primary dropdown-toggle">
                            <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-right">
                              <li><a href="{{ order.view }}"><i class="fa fa-pencil"></i> {{ text_edit }}</a></li>
                              {% if order.status=='Pending'  %}
                               <li><a href="javascript:onhod({{order.order_id}});"  data-toggle="tooltip" ><i class="fa fa-pencil"></i> {{ text_onhold }}</a></li>{% endif %}
                              <li><a href="javascript:cancel({{order.order_id}});"  data-toggle="tooltip" ><i class="fa fa-reply"></i> {{ text_cancel }}</a></li>
                              <li></li>
                            </ul>
                          </div>
                        </div></td>
                    </tr>
                    {% endfor %}
                    
                    {% else %}
                    <tr>
                      <td class="text-center" colspan="8">{{ text_no_results }}</td>
                    </tr>
                    {% endif %}
                      </tbody>
                    
                  </table>
                </div>
                <div class="row">
                  <div class="btn-group" style="float: right; margin-right:20px;"><a href="javascript:pay();" data-toggle="tooltip" title="{{ text_paid_selected }}" class="btn btn-success btn-xs" >{{ text_paid_selected }}</a></div>
                </div>
              </form>
              <div class="row">
                <div class="col-sm-6 text-left">{{ pagination }}</div>
                <!-- <div class="col-sm-6 text-right">{{ results }}</div>--> 
              </div>
            </div>
          </div>
        </div>
        <script src="catalog/view/javascript/jquery/jquery.rotate.min.js" type="text/javascript"></script> 
        <script type="text/javascript"><!--
		
		function payclick(url){
			window.location.href=url;
		}

$('#button-filter').on('click', function() {
	url = '';

	var filter_order_id = $('input[name=\'filter_order_id\']').val();

	if (filter_order_id) {
		url += '&filter_order_id=' + encodeURIComponent(filter_order_id);
	}

	var filter_customer = $('input[name=\'filter_customer\']').val();

	if (filter_customer) {
		url += '&filter_customer=' + encodeURIComponent(filter_customer);
	}

	var filter_order_status_id = $('select[name=\'filter_order_status_id\']').val();

	if (filter_order_status_id !== '') {
		url += '&filter_order_status_id=' + encodeURIComponent(filter_order_status_id);
	}

	var filter_total = $('input[name=\'filter_total\']').val();

	if (filter_total) {
		url += '&filter_total=' + encodeURIComponent(filter_total);
	}

	var filter_date_added = $('input[name=\'filter_date_added\']').val();

	if (filter_date_added) {
		url += '&filter_date_added=' + encodeURIComponent(filter_date_added);
	}

	var filter_date_modified = $('input[name=\'filter_date_modified\']').val();

	if (filter_date_modified) {
		url += '&filter_date_modified=' + encodeURIComponent(filter_date_modified);
	}

	location = 'index.php?route=commonipl/orders/filter&user_token={{ user_token }}' + url;
});
//--></script> 
        <script type="text/javascript"><!--
/*var refreshOrders = true;
	$(document).ready(function() {	
	if(refreshOrders){
		syn(refreshOrders);
		refreshOrders = false;
	}
		//syn(this);
   });*/
  var rotation = function (){
      $(this).rotate({
        angle:0,
        animateTo:360,
        duration: 2000,
        callback: rotation,
        easing: function (x,t,b,c,d){        // t: current time, b: begInnIng value, c: change In value, d: duration
          return c*(t/d)+b;
        }
      });
    }
  function syn(node){
	  $.ajax({
				url: '{{ sys_action }}',
				dataType: 'json',
				cache: false,
				contentType: false,
				processData: false,
				beforeSend: function() {
					  $("#Synchronize").each(rotation);
				},
				complete: function() {
					  $("#Synchronize").stopRotate();
				},
				success: function(json) {
					//alert(json['success']);
					if (json['success']) {
						window.location.reload();
						//window.location.href="index.php?route=shopify/orders#syn";
					}
				},
				error: function(xhr, ajaxOptions, thrownError) {
					//alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				}
			});
	}
	
	
	
	function onhod(order_id){
		//alert(order_id);
	  $.ajax({
				url: 'index.php?route=shopify/orders/onhod&order_id='+order_id,
				dataType: 'json',
				cache: false,
				contentType: false,
				processData: false,
				beforeSend: function() {
					  //$("#Synchronize").each(rotation);
				},
				complete: function() {
					  //$("#Synchronize").stopRotate();
				},
				success: function(json) {
					//alert(json['success']);
					if (json['success']) {
						//$('#pay'+order_id).attr('disabled',"true");
						$('#status'+order_id).html(json['status']);
						//$('#checkbox'+order_id).attr('disabled',"true");
						//window.location.reload();
						//window.location.href="index.php?route=shopify/orders#syn";
					}
				},
				error: function(xhr, ajaxOptions, thrownError) {
					//alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				}
			});
	}
	
	function cancel(order_id){
		//alert(order_id);
		ShopifyApp.Modal.confirm("Are you sure cancel this order?", function(result){
  			if(result){
   				  $.ajax({
				  url: 'index.php?route=shopify/orders/cancel&order_id='+order_id,
				  dataType: 'json',
				  cache: false,
				  contentType: false,
				  processData: false,
				  beforeSend: function() {
						//$("#Synchronize").each(rotation);
				  },
				  complete: function() {
						//$("#Synchronize").stopRotate();
				  },
				  success: function(json) {
					  //alert(json['success']);
					  if (json['success']) {
						  $('#pay'+order_id).attr('disabled',"true");
						  $('#status'+order_id).html(json['status']);
						  $('#checkbox'+order_id).attr('disabled',"true");
						  //window.location.reload();
						  //window.location.href="index.php?route=shopify/orders#syn";
					  }
				  },
				  error: function(xhr, ajaxOptions, thrownError) {
					  //alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				  }
			  	});
  			}
  
		});
	 
	}
	
  function pay(){
	  var selected = $('input[name^=\'selected\']:checked');
	  if(selected.length<=0){
		   alert('Please select a payment order!');
		   return;
	  }
	  var order_id = new Array();
	  var j = 0;
	  for (i = 0; i < selected.length; i++) {
		 if (!$(selected[i]).prop("disabled") && $(selected[i]).val()) {
			order_id[j] =$(selected[i]).val();
			j++;
		}
	 }
	  var formData =  new FormData();
	  formData.append("order_id",order_id);
	  $.ajax({
				url: 'index.php?route=shopify/orders/pay',
				type: 'post',
				data: formData,
				dataType: 'json',
				cache: false,
				contentType: false,
				processData: false,
				success: function(json) {
					if (json['success']) {
						window.location.href="index.php?route=extension/payment/pp_express/checkout";
					}
				},
				error: function(xhr, ajaxOptions, thrownError) {
					alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
				}
			});
	}
  
  
$('input[name=\'filter_customer\']').autocomplete({
	'source': function(request, response) {
		$.ajax({
			url: 'index.php?route=customer/customer/autocomplete&user_token={{ user_token }}&filter_name=' +  encodeURIComponent(request),
			dataType: 'json',
			success: function(json) {
				response($.map(json, function(item) {
					return {
						label: item['name'],
						value: item['customer_id']
					}
				}));
			}
		});
	},
	'select': function(item) {
		$('input[name=\'filter_customer\']').val(item['label']);
	}
});
//--></script> 
        <script type="text/javascript"><!--
$('input[name^=\'selected\']').on('change', function() {
	$('#button-shipping, #button-invoice').prop('disabled', true);

	var selected = $('input[name^=\'selected\']:checked');

	if (selected.length) {
		$('#button-invoice').prop('disabled', false);
	}

	for (i = 0; i < selected.length; i++) {
		if ($(selected[i]).parent().find('input[name^=\'shipping_code\']').val()) {
			$('#button-shipping').prop('disabled', false);

			break;
		}
	}
});

$('#button-shipping, #button-invoice').prop('disabled', true);

$('input[name^=\'selected\']:first').trigger('change');

// IE and Edge fix!
$('#button-shipping, #button-invoice').on('click', function(e) {
	$('#form-order').attr('action', this.getAttribute('formAction'));
});

$('#form-order li:last-child a').on('click', function(e) {
	e.preventDefault();
	
	var element = this;
	
	if (confirm('{{ text_confirm }}')) {
		$.ajax({
			url: '{{ catalog }}index.php?route=api/order/delete&api_token={{ api_token }}&store_id={{ store_id }}&order_id=' + $(element).attr('href'),
			dataType: 'json',
			beforeSend: function() {
				$(element).parent().parent().parent().find('button').button('loading');
			},
			complete: function() {
				$(element).parent().parent().parent().find('button').button('reset');
			},
			success: function(json) {
				$('.alert-dismissible').remove();
	
				if (json['error']) {
					$('#content > .container-fluid').prepend('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
				}
	
				if (json['success']) {
					location = '{{ delete }}';
				}
			},
			error: function(xhr, ajaxOptions, thrownError) {
				alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
			}
		});
	}
});

//--></script> 
        <script src="view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
        <link href="view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css" type="text/css" rel="stylesheet" media="screen" />
        <script type="text/javascript"><!--
$('.date').datetimepicker({
	language: '{{ datepicker }}',
	pickTime: false
});
//--></script></div>
    </div>
  </div>
</div>
{{ footer }} 